<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<head>
    <title>Lua Jepsen documentation</title>
    <link rel="stylesheet" href="../ldoc.css" type="text/css" />
</head>
<body>

<div id="container">

<div id="product">
	<div id="product_logo"></div>
	<div id="product_name"><big><b></b></big></div>
	<div id="product_description"></div>
</div> <!-- id="product" -->


<div id="main">


<!-- Menu -->

<div id="navigation">
<br/>
<h1>Lua Jepsen</h1>

<ul>
  <li><a href="../index.html">Index</a></li>
</ul>

<h2>Contents</h2>
<ul>
<li><a href="#Functions">Functions</a></li>
</ul>


<h2>Modules</h2>
<ul class="nowrap">
  <li><a href="../modules/jepsen.checker.html">jepsen.checker</a></li>
  <li><a href="../modules/jepsen.client.html">jepsen.client</a></li>
  <li><a href="../modules/jepsen.clock.html">jepsen.clock</a></li>
  <li><a href="../modules/jepsen.thread_coroutine.html">jepsen.thread_coroutine</a></li>
  <li><a href="../modules/jepsen.thread_fiber.html">jepsen.thread_fiber</a></li>
  <li><a href="../modules/jepsen.gen.html">jepsen.gen</a></li>
  <li><a href="../modules/jepsen.history.html">jepsen.history</a></li>
  <li><a href="../modules/jepsen.html">jepsen</a></li>
  <li><a href="../modules/jepsen.log.html">jepsen.log</a></li>
  <li><a href="../modules/jepsen.nemesis.html">jepsen.nemesis</a></li>
  <li><a href="../modules/jepsen.op.html">jepsen.op</a></li>
  <li><strong>jepsen.runner</strong></li>
  <li><a href="../modules/jepsen.thread.html">jepsen.thread</a></li>
  <li><a href="../modules/jepsen.utils.html">jepsen.utils</a></li>
</ul>
<h2>Topics</h2>
<ul class="">
  <li><a href="../topics/README.md.html">README</a></li>
</ul>

</div>

<div id="content">

<h1>Module <code>jepsen.runner</code></h1>
<p>Jepsen runner is an entrance point of Lua Jepsen library.</p>
<p>


<h3>Design Overview</h3>

<p> A Jepsen test runs as a Lua program on a control node. That program may use
 remote access to log into a bunch of DB nodes, where it sets up the
 distributed system you're going to test or use local DB instances.</p>

<pre><code>              +-------------+
     +------- | controller  | -------+
     |        +-------------+        |
     |          |    |    |          |
     |     +----+    |    |          |
     v     v         |    |          v
   +----+----+----+  |    |  +----+----+
   | n1 | n2 | n3 | &lt;+    +&gt; | n4 | n5 |
   +----+----+----+          +----+----+
</code></pre>


<p> Once the system is running, the control node spins up a set of logically
 single-threaded processes (see <a href="../modules/jepsen.thread.html#">jepsen.thread</a>), each with its own client for
 the distributed system.</p>

<p> A generator (see <a href="../modules/jepsen.gen.html#">jepsen.gen</a>) generates new operations (see <a href="../modules/jepsen.op.html#">jepsen.op</a>)
 for each process to perform. Processes then apply those operations to the
 system using their clients, see <a href="../modules/jepsen.client.html#">jepsen.client</a>. The start and end of each
 operation is recorded in a history, see <a href="../modules/jepsen.history.html#">jepsen.history</a>. While performing
 operations, a special nemesis process (see <a href="../modules/jepsen.nemesis.html#">jepsen.nemesis</a>) introduces
 faults into the system - also scheduled by the generator.</p>

<p> Finally, the DB is turn down. Jepsen uses a checker (see <a href="../modules/jepsen.checker.html#">jepsen.checker</a>)
 to analyze the test's history for correctness, and to generate reports,
 graphs, etc. The test, history, analysis, and any supplementary results are
 written to the filesystem for later review.</p>

<h3>Performance Tips</h3>

<p> Debug mode: by default tests enables type checking, see statements with
 <code>dev_checks()</code> in source code, and code coverage gathering. This requires
 using Lua <a href="https://www.lua.org/manual/5.1/manual.html#5.9">debug</a> module, that can significantly slowdown of execution (about
 1.6 times). You can control it with environment variable <code>DEV</code>, to run tests
 with disabled type checking and code coverage: <code>DEV=OFF make test</code>.</p>

<p> Tarantool has an integrated statistical profiler with very low overhead. It
 allows sampling the currently executing stack and other parameters in regular
 intervals. It is helpful in searching bottlenecks in Lua code. The high-level
 profiler can also be started and stopped from Lua code with:</p>


<pre>
<span class="global">require</span>(<span class="string">'jit.p'</span>).start(<span class="string">'f'</span>, <span class="string">'profile.txt'</span>)
...
<span class="global">require</span>(<span class="string">'jit.p'</span>).stop()
</pre>

<p> - TODO: Performance of LuaJIT vs PUC Rio Lua: http://luajit.org/performance.html
 - TODO: Performance of fibers vs coroutines.
 - http://lua-users.org/wiki/OptimisationTips
 - Lua Performance Tips https://www.lua.org/gems/sample.pdf
 - Lua Optimisation Guide https://stackoverflow.com/questions/7167566/luajit-2-optimization-guide</p>
</p>


<h2><a href="#Functions">Functions</a></h2>
<table class="function_list">
	<tr>
	<td class="name" nowrap><a href="#run_test">run_test (workload, opts)</a></td>
	<td class="summary">Create test and run.</td>
	</tr>
</table>

<br/>
<br/>


    <h2 class="section-header "><a name="Functions"></a>Functions</h2>

    <dl class="function">
    <dt>
    <a name = "run_test"></a>
    <strong>run_test (workload, opts)</strong>
    </dt>
    <dd>
    Create test and run.


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">workload</span> Table with workload options.
        <ul>
        <li><span class="parameter">create_client</span>
         Function that creates a workload client. Learn
 more about creating clients in <a href="../modules/jepsen.client.html#">jepsen.client</a>.
        </li>
        <li><span class="parameter">generator</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.1/manual.html#5.5">table</a></span>
         Generator of operations used in test workload.
 Generator must be a table with <code>unwrap()</code> method that returns an iterator
 triplet. You can make generator youself or use <a href="../modules/jepsen.gen.html#">jepsen.gen</a> module.
        </li>
        <li><span class="parameter">checker</span>
         Function for checking history in workload.
         (<em>optional</em>)
        </li>
        </li></ul>
        <li><span class="parameter">opts</span> Table with test options.
        <ul>
        <li><span class="parameter">logging</span>
            <span class="types"><span class="type">boolean</span></span>
         Option to control logging history to files:
 history.txt with plain history, and history.json with history encoded to
 JSON. Disabled by default.
         (<em>optional</em>)
        </li>
        <li><span class="parameter">threads</span>
            <span class="types"><span class="type">number</span></span>
         Number of threads in a test workload, default
 value is 1.
         (<em>optional</em>)
        </li>
        <li><span class="parameter">thread_type</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.1/manual.html#5.4">string</a></span>
         Type of threads used in a test workload.
 Possible values are 'fiber' (see <a href="../modules/jepsen.thread_fiber.html#">jepsen.thread_fiber</a>) and 'coroutine' (see
 <a href="../modules/jepsen.thread_coroutine.html#">jepsen.thread_coroutine</a>), default value is 'fiber' on Tarantool and
 'coroutine' on LuaJIT. Learn more about possible thread types in
 <a href="../modules/jepsen.thread.html#">jepsen.thread</a>.
         (<em>optional</em>)
        </li>
        <li><span class="parameter">time_limit</span>
            <span class="types"><span class="type">number</span></span>
         Number of seconds to limit time of testing. By
 default testing time is endless and limited by a number of operations
 produced by generator.
         (<em>optional</em>)
        </li>
        <li><span class="parameter">nodes</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.1/manual.html#5.5">table</a></span>
         A table that contains IP addresses of nodes
 participated in testing.
         (<em>optional</em>)
        </li>
        </li></ul>
    </ul>

    <h3>Returns:</h3>
    <ol>

        true on success or nil with error
    </ol>


    <h3>See also:</h3>
    <ul>
         <li><a href="../modules/jepsen.gen.html#">jepsen.gen</a></li>
         <li><a href="../modules/jepsen.client.html#">jepsen.client</a></li>
    </ul>

    <h3>Usage:</h3>
    <ul>
        <pre class="example"><span class="keyword">local</span> test_options = {
    logging = <span class="keyword">true</span>,
    thread_type = <span class="string">'fiber'</span>,
    threads = <span class="number">5</span>,
    nodes = {
        <span class="string">'127.0.0.1'</span>
    }
}
<span class="keyword">local</span> ok, err = jepsen.run_test({
    create_client = new,
    generator = gen_lib.cycle(gen_lib.iter({ r, w })):take(<span class="number">1000</span>)
}, test_options)</pre>
    </ul>

</dd>
</dl>


</div> <!-- id="content" -->
</div> <!-- id="main" -->
<div id="about">
<i>generated by <a href="http://github.com/stevedonovan/LDoc">LDoc 1.4.6</a></i>
<i style="float:right;">Last updated 2021-12-09 20:17:33 </i>
</div> <!-- id="about" -->
</div> <!-- id="container" -->
</body>
</html>
